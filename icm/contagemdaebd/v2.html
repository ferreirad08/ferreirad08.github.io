<!DOCTYPE html>

<html>
  <head>
    <link
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      rel="stylesheet"
    />
    <style>
      canvas,
      #map {
        width: 100%;
        height: 260px;
        border-radius: 4px;
        margin-bottom: 10px;
        box-shadow: -1px 1px 4px 0px grey;
      }

      tr:nth-child(odd) {
        background-color: #cccccc;
      }

      th {
        background-color: #151b54;
        color: #fff;
      }

      th,
      td {
        padding: 8px;
        text-align: left;
        font-size: 10px;
      }

      table {
        width: 100%;
        border-radius: 4px;
        margin-bottom: 10px;
        box-shadow: -1px 1px 4px 0px grey;
        border-collapse: collapse;
        overflow: hidden;
      }
    </style>
    <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8" />
    <title></title>
  </head>

  <body>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>ID</th>
          <th>Cidade</th>
          <th>Estado</th>
          <th>Último acesso</th>
          <th>Acessos</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <canvas id="bar"></canvas>
    <canvas id="cumulative"></canvas>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script>
      const bar = new Chart("bar", {
        type: "bar",
        data: {
          labels: [],
          datasets: [
            {
              label: "",
              data: [],
              backgroundColor: "#36A2EB",
              borderColor: "#36A2EB",
              borderWidth: 1,
            },
          ],
        },
        options: {
          title: {
            display: true,
            text: "Acessos por ID",
            position: "top",
            align: "start",
          },
          legend: { display: false },
          scales: {
            xAxes: [
              {
                gridLines: {
                  display: false,
                },
                ticks: {
                  autoSkip: true,
                  maxRotation: 45,
                  minRotation: 45,
                },
                scaleLabel: {
                  display: true,
                  labelString: "ID",
                },
              },
            ],
            yAxes: [
              {
                gridLines: {
                  borderDash: [4, 4],
                },
                ticks: {
                  beginAtZero: true,
                },
              },
            ],
          },
        },
      });

      const cumulative = new Chart("cumulative", getOptions("Acessos por dia"));

      function getOptions(title) {
        return {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: title,
                fill: false,
                lineTension: 0,
                backgroundColor: "rgb(108,145,61)",
                borderColor: "rgb(108,145,61)",
                radius: 0,
                borderWidth: 1,
                data: [],
              },
            ],
          },
          options: {
            title: {
              display: true,
              text: title,
              position: "top",
              align: "start",
            },
            legend: {
              display: false,
              position: "top",
              align: "start",
            },
            scales: {
              xAxes: [
                {
                  gridLines: {
                    display: false,
                  },
                  ticks: {
                    autoSkip: true,
                    maxRotation: 90,
                    minRotation: 90,
                  },
                  scaleLabel: {
                    display: true,
                    labelString: "Tempo",
                  },
                },
              ],
              yAxes: [
                {
                  gridLines: {
                    borderDash: [4, 4],
                  },
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
            },
          },
        };
      }

      function getUniquesAndFrequencies(data) {
        let timestamps = [];

        for (id in data) {
          timestamps.splice(
            timestamps.length,
            0,
            ...(data[id].days || data[id])
          );
        }

        timestamps = timestamps.sort((a, b) => new Date(a) - new Date(b));
        const frequencyMap = {};

        timestamps.forEach((element) => {
          const day = element.split("T")[0];
          frequencyMap[day] = (frequencyMap[day] || 0) + 1;
        });

        cumulative.data.labels = Object.keys(frequencyMap);
        cumulative.data.datasets[0].data = Object.values(frequencyMap);
        cumulative.update();
      }

      function showData(id) {
        window.alert(JSON.stringify(collection[id], null, 4));
      }

      let collection;
      const tbody = document.getElementById("tbody");

      const div = document.getElementById("map");
      const map = L.map(div);
      L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      const icon = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/ferreirad08/ferreirad08.github.io/refs/heads/main/icm/grupododia/assets/icm-logo.png",
        iconSize: [1007 / 20, 265 / 20],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20],
      });

      function addPoint(name, latlng) {
        const target = L.latLng(latlng);
        map.setView(target, 3);
        L.marker(target, { icon })
          .addTo(map)
          .bindPopup(`<b>${name}</b><br /><a onclick="showData('${name}')">+ Informações</a><br />`);
      }

      async function update() {
        collection = window.localStorage.getItem("david-test");
        collection = collection === null ? {} : JSON.parse(collection);

        const url = "https://jsonblob.com/api/jsonBlob/1308416807962599424";
        const _document = await (await fetch(url)).json();

        collection[_document.id] = _document;
        // delete collection[undefined];
        window.localStorage.setItem("david-test", JSON.stringify(collection));

        getUniquesAndFrequencies(collection);

        bar.data.labels = [];
        bar.data.datasets[0].data = [];

        tbody.innerHTML = "";
        let index = 0;

        for (const id in collection) {
          const item = collection[id];
          bar.data.labels.push(id.slice(20));
          bar.data.datasets[0].data.push(item.days?.length || item.length);

          if ("geojson" in item) {
            addPoint(id, [item.geojson.latitude, item.geojson.longitude]);
          }

          const row = tbody.insertRow(index);
          row.insertCell(0).innerHTML = index + 1;
          row.insertCell(1).innerHTML = id.slice(20);
          row.insertCell(2).innerHTML = item.geojson?.city || "";
          row.insertCell(3).innerHTML = item.geojson?.region || "";
          row.insertCell(4).innerHTML = item.days?.at(-1) || item.at(-1);
          row.insertCell(5).innerHTML = item.days?.length || item.length;
          index++;
        }

        bar.update();
        setTimeout(update, 10 * 1000);
      }

      update();
    </script>
  </body>
</html>
