<!DOCTYPE html>

<html>
  <head>
    <style>
      canvas {
        max-width: 500px;
      }
    </style>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard</title>
  </head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <body>
    <canvas id="humidity"></canvas>
    <br />
    <canvas id="temperature"></canvas>
    <br />
    <canvas id="luminosity"></canvas>
    <br />
    <button onclick="window.localStorage.clear('dashboard')">
      Limpar dados
    </button>
    <script>
      const humidity = new Chart("humidity", getOptions("Umidade do Ar (%)"));
      const temperature = new Chart(
        "temperature",
        getOptions("Temperatura do Ar (Â°C)")
      );
      const luminosity = new Chart(
        "luminosity",
        getOptions("Luminosidade (lx)")
      );

      const query = queryString();

      let data = window.localStorage.getItem("dashboard");
      data =
        data === null
          ? { time: [], humidity: [], temperature: [], luminosity: [] }
          : JSON.parse(data);

      populate();
      run();

      function getOptions(title) {
        return {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: title,
                fill: false,
                lineTension: 0,
                backgroundColor: "rgb(108,145,61)",
                borderColor: "rgb(108,145,61)",
                radius: 0,
                borderWidth: 1,
                data: [],
              },
            ],
          },
          options: {
            title: {
              display: true,
              text: title,
              position: "top",
              align: "start",
            },
            legend: {
              display: false,
              position: "top",
              align: "start",
            },
            scales: {
              xAxes: [
                {
                  gridLines: {
                    display: false,
                  },
                  ticks: {
                    autoSkip: true,
                    maxRotation: 90,
                    minRotation: 90,
                  },
                  scaleLabel: {
                    display: true,
                    labelString: "Tempo",
                  },
                },
              ],
              yAxes: [
                {
                  gridLines: {
                    borderDash: [4, 4],
                  },
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
            },
          },
        };
      }

      function queryString() {
        const parameters = {};
        for (const item of window.location.search.slice(1).split("&")) {
          const [key, value] = item.split("=");
          parameters[key] = value;
        }
        return parameters;
      }

      async function populate() {
        humidity.data.labels = data.time;
        humidity.data.datasets[0].data = data.humidity;
        humidity.update();

        temperature.data.labels = data.time;
        temperature.data.datasets[0].data = data.temperature;
        temperature.update();

        luminosity.data.labels = data.time;
        luminosity.data.datasets[0].data = data.luminosity;
        luminosity.update();
      }

      const timeOptions = {
        timeZone: "UTC",
        day: "2-digit",
        month: "numeric",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
      };

      async function run() {
        const payload = await (
          await fetch(`https://jsonblob.com/api/jsonBlob/${query.code}`)
        ).json();
        console.log(JSON.stringify(payload, null, 4));

        const time = new Date(payload.data[0].time / 1000).toLocaleString(
          "pt-BR",
          timeOptions
        );

        measurements = {};
        for (item of payload.data) measurements[item.ref] = item.value;

        if (data.time.at(-1) !== time) {
          data.time.push(time);
          data.humidity.push(measurements.emw_humidity_humidity);
          data.temperature.push(
            measurements.emw_temperature_temperature - 273.15
          );
          data.luminosity.push(measurements.emw_luminosity_lux);

          window.localStorage.setItem("dashboard", JSON.stringify(data));

          await populate();
        }

        window.setTimeout(run, Number(query.refresh) * 1000);
      }
    </script>
  </body>
</html>
